@using InventoryManagement.Repository
@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles{
    <style>
        #daily-report p { font-weight: 400; color: #212121; font-size: 1rem }
        #daily-report p a { font-weight: 400; color: #212121; font-size: 1rem }

        .active-cyan-2 input.form-control[type=text]:focus:not([readonly]) { border-bottom: 1px solid #3fa3e2; box-shadow: 0 1px 0 0 #3fa3e2; }
        .active-cyan-2 .fas { color: #3144a2; }
        .fa-spinner { pointer-events: none }
    </style>
}

@{
    var businessStatus = (Model.CustomerDue + Model.StockProductPurchaseValue) - Model.MarketDue;
}

<div class="container-fluid">
    @if (User.IsInRole("admin"))
    {
        <section class="mt-4">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card">
                        <div class="row mt-4 mb-3">
                            <div class="col-md-3 col-3 text-left pl-4">
                                <div class="p-2 m-2 fa-lg">
                                    <i class="far fa-business-time fa-2x @(businessStatus > 0 ? "text-success" : "text-danger")"></i>
                                </div>
                            </div>
                            <div class="col-md-9 col-9 text-right pr-5">
                                <p class="text-dark mb-2">Business Status</p>
                                <h4 class="ml-4 font-weight-bold h4-responsive @(businessStatus > 0 ? "text-success" : "text-danger")">৳@businessStatus</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card">
                        <div class="row mt-4 mb-3">
                            <div class="col-md-3 col-3 text-left pl-4">
                                <div class="p-2 m-2 fa-lg">
                                    <i class="fas fa-analytics fa-2x blue-text"></i>
                                </div>
                            </div>
                            <div class="col-md-9 col-9 text-right pr-5">
                                <p class="text-dark mb-2">Market Due</p>
                                <h4 class="ml-4 font-weight-bold h4-responsive">৳@Model.MarketDue</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card">
                        <div class="row mt-4 mb-3">
                            <div class="col-md-3 col-3 text-left pl-4">
                                <div class="p-2 m-2 fa-lg">
                                    <i class="far fa-user-chart fa-2x red-text"></i>
                                </div>
                            </div>
                            <div class="col-md-9 col-9 text-right pr-5">
                                <p class="text-dark mb-2">Customer Due</p>
                                <h4 class="ml-4 font-weight-bold h4-responsive">৳@Model.CustomerDue</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card">
                        <div class="row mt-4 mb-3">
                            <div class="col-md-3 col-3 text-left pl-4">
                                <div class="p-2 m-2 fa-lg">
                                    <i class="far fa-shopping-bag fa-2x orange-text"></i>
                                </div>
                            </div>
                            <div class="col-md-9 col-9 text-right pr-5">
                                <p class="text-dark mb-2">Product(taka)</p>
                                <h4 class="ml-4 font-weight-bold h4-responsive">৳@Model.StockProductPurchaseValue</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="daily-report" class="mb-5 mt-1">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Daily Report</h5>
                <form id="findForm">
                    <div class="input-group">
                        <input id="inputFindDate" class="form-control my-0 py-1 datepicker" type="text" placeholder="Search By Date">
                        <div class="input-group-append">
                            <button id="btnFind" type="submit" class="btn btn-md btn-grey m-0 py-2 px-3">
                                <i id="icoFind" class="fas fa-search text-grey"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="media white z-depth-1 rounded">
                        <i class="fas fa-tags fa-2x light-blue darken-3 z-depth-1 p-4 rounded-left text-white mr-3"></i>
                        <div class="media-body mt-3">
                            <p class="mb-0">
                                <a id="linkSales">Total Sale <i class="far fa-long-arrow-alt-right"></i></a>
                            </p>
                            <h5 class="font-weight-bold mb-0">
                                ৳<span id="totalSale"></span>
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="media white z-depth-1 rounded">
                        <i class="fas fa-shopping-bag fa-2x primary-color-dark z-depth-1 p-4 rounded-left text-white mr-3"></i>
                        <div class="media-body mt-3">
                            <p class="mb-0">
                                <a id="linkSold">Today’s Sold Products <i class="far fa-long-arrow-alt-right"></i></a>
                            </p>
                            <h5 class="font-weight-bold mb-0">
                                ৳<span id="totalProductSold"></span>
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="media white z-depth-1 rounded">
                        <i class="fas fa-wallet fa-2x green darken-1 z-depth-1 p-4 rounded-left text-white mr-3"></i>
                        <div class="media-body mt-3">
                            <p class="mb-0">
                                <a id="linkCash">Cash Collection <i class="far fa-long-arrow-alt-right"></i></a>
                            </p>
                            <h5 class="font-weight-bold mb-0">
                                ৳<span id="totalCashCollection"></span>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="media white z-depth-1 rounded">
                        <i class="fas fa-chart-pie fa-2x pink z-depth-1 p-4 rounded-left text-white mr-3"></i>
                        <div class="media-body mt-3">
                            <p class="mb-0">Expense</p>
                            <h5 class="font-weight-bold mb-0">
                                ৳<span id="totalExpense"></span>
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="media white z-depth-1 rounded">
                        <i class="fas fa-chart-line fa-2x deep-purple darken-3 z-depth-1 p-4 rounded-left text-white mr-3"></i>
                        <div class="media-body mt-3">
                            <p class="mb-0">Profit</p>
                            <h5 class="font-weight-bold mb-0">
                                ৳<span id="totalProfit"></span>
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="media white z-depth-1 rounded">
                        <i class="far fa-chart-bar fa-2x brown darken-2 z-depth-1 p-4 rounded-left text-white mr-3"></i>
                        <div class="media-body mt-3">
                            <p class="mb-0">Net</p>
                            <h5 class="font-weight-bold mb-0">
                                ৳<span id="totalNetProfit"></span>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </section>  
    }

    <section class="row mb-5">
        <div class="col-xl-5 col-lg-5 mb-3">
            <div class="card card-cascade narrower">
                <div class="view view-cascade gradient-card-header blue-gradient lighten-1 p-3">
                    <h3 class="h3-responsive mb-0 p-1 font-weight-light">Due Vendors</h3>
                </div>

                <div class="card-body card-body-cascade">
                    <div class="form-inline d-flex justify-content-center align-items-center md-form form-sm active-cyan-2 mb-0 mt-2">
                        <input id="vendor-input-find" class="form-control form-control-sm mb-0 w-75" type="text" placeholder="Search">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </div>

                    <table id="table-vendor" class="table table-sm">
                        <thead>
                            <tr>
                                <th><strong>Company</strong></th>
                                <th><strong>Amount</strong></th>
                                <th><strong>Paid</strong></th>
                                <th><strong>Due</strong></th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        @if (User.IsInRole("admin"))
        {
            <div class="col-xl-7 col-lg-7">
                <div class="card card-cascade narrower">
                    <div class="view view-cascade gradient-card-header blue-gradient mb-3">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        }
    </section>

    <section>
        <div class="row">
            <div class="col-xl-5 mb-3">
                <div class="card card-cascade narrower">
                    <div class="view view-cascade gradient-card-header blue-gradient p-3">
                        <div class="md-form m-0">
                            <h3 class="h3-responsive mb-0 p-1 font-weight-light">
                                Due Customers
                            </h3>
                        </div>
                    </div>
                    <div class="card-body card-body-cascade pt-0">
                        <div class="form-inline d-flex justify-content-center align-items-center md-form form-sm active-cyan-2 mb-0 mt-2">
                            <input id="input-find" class="form-control form-control-sm mb-0 w-75" type="text" placeholder="Search">
                            <i class="fas fa-search" aria-hidden="true"></i>
                        </div>

                        <table id="table-customer" class="table table-sm">
                            <thead>
                                <tr>
                                    <th><strong>Name</strong></th>
                                    <th><strong>Due</strong></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>

            @if (User.IsInRole("admin"))
            {
                <div class="col-xl-7">
                    <div class="card card-body pb-0 mb-4">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th class="font-weight-bold dark-grey-text"><strong>Month</strong></th>
                                    <th class="font-weight-bold dark-grey-text"><strong>Sales</strong></th>
                                    <th class="font-weight-bold dark-grey-text"><strong>Purchase</strong></th>
                                    <th class="font-weight-bold dark-grey-text"><strong>Expense</strong></th>
                                    <th class="font-weight-bold dark-grey-text"><strong>Profit</strong></th>
                                    <th class="font-weight-bold dark-grey-text"><strong>Avg. Profit</strong></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.MonthlySummary)
                                {
                                    <tr>
                                        <td>@item.Month.Month</td>
                                        <td>@item.MonthlySale</td>
                                        <td>@item.MonthlyNewPurchase</td>
                                        <td>@item.MonthlyExpense</td>
                                        <td>@item.MonthlyProfit</td>
                                        <td>@item.DailyAverageProfit</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    </section>
</div>

@section Scripts {
    <script>
        $(function() {
            //date picker
            $('.datepicker').pickadate({
                format: 'd-mmmm-yyyy'
            }).val(moment(new Date()).format('DD-MMMM-YYYY'));


            //vendor data-table
            const customerTable = $('#table-customer').DataTable({
                processing: true,
                serverSide: true,
                pageLength: 12,
                dom: 't',
                ajax: {
                    url: "/Dashboard/TopDueCustomer",
                    type: "POST"
                },
                columns:
                [
                    {
                        data: "Name", "render": function(data, type, row, meta) {
                            return `<a class="blue-text" href="/Customer/Details/${row.CustomerId}">${data}</a>`;
                        }
                    },
                    { data: "Due" }
                ],
                order: [[1, 'desc']]
            });

            //on search input
            $('#input-find').on("input", function() {
                customerTable.search($(this).val()).draw();
            });


            //vendor data-table
            const vendorTable = $('#table-vendor').DataTable({
                processing: true,
                serverSide: true,
                pageLength: 6,
                dom: 't',
                ajax: {
                    url: "/Dashboard/TopDueVendor",
                    type: "POST"
                },
                columns:
                [
                    { data: "VendorCompanyName" },
                    { data: "TotalAmount" },
                    { data: "VendorPaid" },
                    { data: "VendorDue" }
                ]
            });

            //on search input
            $('#vendor-input-find').on("input", function() {
                vendorTable.search($(this).val()).draw();
            })
        });


        let months = [];
        let sales = [];
        let purchase = [];
        let profit = [];
        let expense = [];

        @foreach (var item in Model.MonthlySummary)
        {
            @:months.push("@item.Month.Month");
            @:sales.push(@item.MonthlyNewPurchase);
            @:purchase.push(@item.MonthlySale);
            @:profit.push(@item.MonthlyProfit);
            @:expense.push(@item.MonthlyExpense);
        }

        // Line chart
        const ctxL = document.getElementById("lineChart").getContext('2d');
        const myLineChart = new Chart(ctxL, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: "PURCHASE",
                        fillColor: "#fff",
                        borderColor: 'rgba(76, 175, 80, 0.7)',
                        data: purchase,
                        borderWidth: 3
                    },
                    {
                        label: "SALES",
                        fillColor: "#fff",
                        borderColor: 'rgba(205, 220, 57, 0.8)',
                        data: sales,
                        borderWidth: 3
                    },
                    {
                        label: "PROFIT",
                        fillColor: "#fff",
                        borderColor: 'rgba(63, 81, 181, 0.8)',
                        data: profit,
                        borderWidth: 3
                    },
                    {
                        label: "EXPENSE",
                        fillColor: "#fff",
                        borderColor: 'rgba(244, 67, 54, 0.8)',
                        data: expense,
                        borderWidth: 3
                    }
                ]
            },
            options: {
                legend: {
                    labels: { fontColor: "#fff" }
                },
                scales: {
                    xAxes: [{
                        gridLines: {
                            display: true,
                            color: "rgba(255,255,255,.25)"
                        },
                        ticks: { fontColor: "#fff" }
                    }],
                    yAxes: [{
                        display: true,
                        gridLines: {
                            display: true,
                            color: "rgba(255,255,255,.25)"
                        },
                        ticks: { fontColor: "#fff" }
                    }]
                }
            }
        });

        //on find click
        const findForm = document.getElementById("findForm");

        //add date to link
        const defaultDate = moment(new Date()).format('DD-MMMM-YYYY');

        const linkSales = document.querySelector("#linkSales");
        const linkCash = document.querySelector("#linkCash");
        const linkSold = document.querySelector("#linkSold");

        linkSales.setAttribute("href", `/Selling/SalesReport/${defaultDate}`);
        linkCash.setAttribute("href", `/Selling/CashCollection/${defaultDate}`);
        linkSold.setAttribute("href", `/Selling/ProductSoldReport/${defaultDate}`);

        //find btn click
        findForm.addEventListener("submit", function(evt) {
            evt.preventDefault();

            const date = findForm.inputFindDate.value;
            getDailyData(date)
        });

        //get data on load
        getDailyData(defaultDate);


        //bind daily data
        function getDailyData(date) {
            const totalSale = document.querySelector("#totalSale");
            const totalCashCollection = document.querySelector("#totalCashCollection");
            const totalProductSold = document.querySelector("#totalProductSold");
            const totalExpense = document.querySelector("#totalExpense");
            const totalProfit = document.querySelector("#totalProfit");
            const totalNetProfit = document.querySelector("#totalNetProfit");
            const icoFind = findForm.querySelector("#icoFind");

            //add date to link
            linkSales.setAttribute("href", `/Selling/SalesReport/${date}`);
            linkCash.setAttribute("href", `/Selling/CashCollection/${date}`);
            linkSold.setAttribute("href", `/Selling/ProductSoldReport/${date}`);

            //show loading
            showSpinner(icoFind, true);

            $.ajax({
                type: "POST",
                url: "/Dashboard/DailyReport",
                data: { date },
                success: function(response) {
                    const { TotalSale, ProductSold, CashCollection, Expense, Profit, NetProfit } = response;
                    totalSale.textContent = TotalSale;
                    totalCashCollection.textContent = CashCollection;
                    totalProductSold.textContent = ProductSold;
                    totalExpense.textContent = Expense;
                    totalProfit.textContent = Profit;


                    totalNetProfit.textContent = NetProfit;
                    if (NetProfit > 0) {
                        totalNetProfit.parentElement.classList.add("text-success");
                        totalNetProfit.parentElement.classList.remove("text-danger");
                    } else {
                        totalNetProfit.parentElement.classList.remove("text-success");
                        totalNetProfit.parentElement.classList.add("text-danger");
                    }


                    //hide loading
                    showSpinner(icoFind, false);
                },
                error: function(err) {
                    console.log(err)
                }
            });
        }

        //show spinner
        function showSpinner(element, isShow) {
            if (isShow) {
                findForm.btnFind.disabled = true;
                element.classList.remove("fa-search");
                element.classList.add("fa-spinner", "fa-spin");
            } else {
                findForm.btnFind.disabled = false;
                element.classList.remove("fa-spinner", "fa-spin");
                element.classList.add("fa-search");
            }
        }
    </script>
}